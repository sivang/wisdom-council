# wisdom-council - Deploy Pipeline (AWS)
# Generated by: bedsheet deploy --target aws
#
# Multi-environment deployment: dev â†’ staging â†’ prod
# Uses AWS CDK for infrastructure management.

name: Deploy

on:
  push:
    branches:
      - main
    paths:
      - 'stacks/**'
      - 'lambda/**'
      - 'app.py'
      - '.github/workflows/deploy.yaml'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  AWS_REGION: eu-central-1
  PYTHON_VERSION: "3.11"

jobs:
  # Deploy to Dev (automatic on main push)
  deploy-dev:
    if: github.event_name == 'push' || github.event.inputs.environment == 'dev'
    runs-on: ubuntu-latest
    environment: dev
    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js (for CDK CLI)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install CDK CLI
        run: npm install -g aws-cdk

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt
          cd lambda && pip install -r requirements.txt -t . && cd ..

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: CDK Bootstrap (if needed)
        run: cdk bootstrap aws://${{ vars.AWS_ACCOUNT_ID }}/${{ env.AWS_REGION }} || true

      - name: CDK Deploy (Dev)
        run: |
          cdk deploy --all --require-approval never \
            --context environment=dev \
            --context commit_sha=${{ github.sha }}

      - name: Output Stack Info
        run: |
          echo "### Dev Deployment Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "Environment: dev" >> $GITHUB_STEP_SUMMARY
          echo "Region: ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY

  # Deploy to Staging (manual trigger)
  deploy-staging:
    if: github.event.inputs.environment == 'staging'
    runs-on: ubuntu-latest
    environment: staging
    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js (for CDK CLI)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install CDK CLI
        run: npm install -g aws-cdk

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt
          cd lambda && pip install -r requirements.txt -t . && cd ..

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: CDK Deploy (Staging)
        run: |
          cdk deploy --all --require-approval never \
            --context environment=staging \
            --context commit_sha=${{ github.sha }}

      - name: Output Stack Info
        run: |
          echo "### Staging Deployment Complete! ðŸŽ¯" >> $GITHUB_STEP_SUMMARY
          echo "Environment: staging" >> $GITHUB_STEP_SUMMARY

  # Deploy to Production (manual only, requires approval)
  deploy-prod:
    if: github.event.inputs.environment == 'prod'
    runs-on: ubuntu-latest
    environment: production  # Requires manual approval in GitHub
    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js (for CDK CLI)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install CDK CLI
        run: npm install -g aws-cdk

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt
          cd lambda && pip install -r requirements.txt -t . && cd ..

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: CDK Deploy (Production)
        run: |
          cdk deploy --all --require-approval never \
            --context environment=prod \
            --context commit_sha=${{ github.sha }}

      - name: Output Stack Info
        run: |
          echo "### Production Deployment Complete! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "Environment: production" >> $GITHUB_STEP_SUMMARY
          echo "Region: ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY