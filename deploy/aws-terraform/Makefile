# wisdom-council - Makefile for Terraform Deployment
# Generated by: bedsheet generate --target aws-terraform

.PHONY: help setup init plan deploy destroy clean workspace-list workspace-dev workspace-staging workspace-prod

# Current workspace (default to dev)
WORKSPACE ?= dev

help:  ## Show this help message
	@echo "wisdom-council - AWS Bedrock Terraform Deployment"
	@echo ""
	@echo "Current workspace: $$(terraform workspace show 2>/dev/null || echo 'default')"
	@echo ""
	@echo "Available targets:"
	@awk 'BEGIN {FS = ":.*##"; printf "\n"} /^[a-zA-Z_-]+:.*##/ { printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2 }' $(MAKEFILE_LIST)
	@echo ""
	@echo "Usage examples:"
	@echo "  make workspace-dev deploy    # Deploy to dev workspace"
	@echo "  make workspace-prod deploy   # Deploy to production workspace"
	@echo "  make WORKSPACE=staging plan  # Plan changes in staging"

setup:  ## Install dependencies
	@echo "Installing Terraform..."
	@which terraform || (echo "Please install Terraform: https://www.terraform.io/downloads" && exit 1)
	@echo "Terraform is installed"

init:  ## Initialize Terraform
	terraform init

workspace-list:  ## List all workspaces
	@terraform workspace list

workspace-dev:  ## Switch to dev workspace
	@terraform workspace select dev 2>/dev/null || terraform workspace new dev
	@echo "Switched to dev workspace"

workspace-staging:  ## Switch to staging workspace
	@terraform workspace select staging 2>/dev/null || terraform workspace new staging
	@echo "Switched to staging workspace"

workspace-prod:  ## Switch to production workspace
	@terraform workspace select production 2>/dev/null || terraform workspace new production
	@echo "Switched to production workspace"

plan:  ## Plan Terraform changes
	@echo "Planning changes for workspace: $$(terraform workspace show)"
	terraform plan -var-file=terraform.tfvars

deploy:  ## Deploy to AWS
	@echo "Deploying to workspace: $$(terraform workspace show)"
	terraform apply -auto-approve -var-file=terraform.tfvars
	@echo ""
	@echo "Deployment complete for workspace: $$(terraform workspace show)"
	@echo ""
	@echo "Next steps:"
	@echo "  1. Set environment variables:"
	@echo "     export BEDROCK_AGENT_ID=$$(terraform output -raw supervisor_agent_id)"
	@echo "     export BEDROCK_AGENT_ALIAS=$$(terraform output -raw supervisor_alias_id)"
	@echo "     export AWS_REGION=eu-central-1"
	@echo ""
	@echo "  2. Start Debug UI:"
	@echo "     python debug-ui/server.py"
	@echo ""
	@echo "  3. Open http://localhost:8080 in your browser"

destroy:  ## Destroy AWS resources
	@echo "WARNING: About to destroy resources in workspace: $$(terraform workspace show)"
	@read -p "Are you sure? Type 'yes' to continue: " confirm && [ "$$confirm" = "yes" ] || (echo "Aborted" && exit 1)
	terraform destroy -auto-approve -var-file=terraform.tfvars

clean:  ## Clean generated files
	rm -rf .terraform terraform.tfstate* lambda.zip

outputs:  ## Show Terraform outputs
	@echo "Outputs for workspace: $$(terraform workspace show)"
	@terraform output